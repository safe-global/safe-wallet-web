import type { DataDecoded, TransactionDetails } from '@safe-global/safe-gateway-typescript-sdk'
import { _getSetupFromDataDecoded, usePredictSafeAddressFromTxDetails } from '../usePredictSafeAddressFromTxDetails'
import { renderHook } from '@testing-library/react'

// @see https://safe-client.safe.global/v1/chains/11155111/transactions/multisig_0x57c26D4d117c926A872814fa46C179691f580e84_0xd0d519d3ebd6efac7a9d7c591c0a311193b6acbbf5db970fab6a51e1d3509e72
const createProxyWithNonce = {
  safeAddress: '0x57c26D4d117c926A872814fa46C179691f580e84',
  txId: 'multisig_0x57c26D4d117c926A872814fa46C179691f580e84_0xd0d519d3ebd6efac7a9d7c591c0a311193b6acbbf5db970fab6a51e1d3509e72',
  executedAt: 1732816512000,
  txStatus: 'SUCCESS',
  txInfo: {
    type: 'Custom',
    humanDescription: null,
    to: {
      value: '0x4e1DCf7AD4e460CfD30791CCC4F9c8a4f820ec67',
      name: 'SafeProxyFactory 1.4.1',
      logoUri:
        'https://safe-transaction-assets.safe.global/contracts/logos/0x4e1DCf7AD4e460CfD30791CCC4F9c8a4f820ec67.png',
    },
    dataSize: '580',
    value: '0',
    methodName: 'createProxyWithNonce',
    actionCount: null,
    isCancellation: false,
  },
  txData: {
    hexData:
      '0x1688f0b900000000000000000000000041675c099f32341bf84bfc5382af534df5c7461a0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000b00000000000000000000000000000000000000000000000000000000000001a4b63e800d00000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000bd89a1ce4dde368ffab0ec35506eece0b1ffdc540000000000000000000000000000000000000000000000000000000000000140000000000000000000000000fd0732dc9e303f09fcef3a7388ad10a83459ec99000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000057c26d4d117c926a872814fa46c179691f580e840000000000000000000000000000000000000000000000000000000000000024fe51f64300000000000000000000000029fcb43b46531bca003ddc8fcb67ffe91900c7620000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
    dataDecoded: {
      method: 'createProxyWithNonce',
      parameters: [
        {
          name: '_singleton',
          type: 'address',
          value: '0x41675C099F32341bf84BFc5382aF534df5C7461a',
          valueDecoded: null,
        },
        {
          name: 'initializer',
          type: 'bytes',
          value:
            '0xb63e800d00000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000bd89a1ce4dde368ffab0ec35506eece0b1ffdc540000000000000000000000000000000000000000000000000000000000000140000000000000000000000000fd0732dc9e303f09fcef3a7388ad10a83459ec99000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000057c26d4d117c926a872814fa46c179691f580e840000000000000000000000000000000000000000000000000000000000000024fe51f64300000000000000000000000029fcb43b46531bca003ddc8fcb67ffe91900c76200000000000000000000000000000000000000000000000000000000',
          valueDecoded: null,
        },
        { name: 'saltNonce', type: 'uint256', value: '11', valueDecoded: null },
      ],
    },
    to: {
      value: '0x4e1DCf7AD4e460CfD30791CCC4F9c8a4f820ec67',
      name: 'SafeProxyFactory 1.4.1',
      logoUri:
        'https://safe-transaction-assets.safe.global/contracts/logos/0x4e1DCf7AD4e460CfD30791CCC4F9c8a4f820ec67.png',
    },
    value: '0',
    operation: 0,
    trustedDelegateCallTarget: null,
    addressInfoIndex: {
      '0x41675C099F32341bf84BFc5382aF534df5C7461a': {
        value: '0x41675C099F32341bf84BFc5382aF534df5C7461a',
        name: 'Safe 1.4.1',
        logoUri:
          'https://safe-transaction-assets.safe.global/contracts/logos/0x41675C099F32341bf84BFc5382aF534df5C7461a.png',
      },
    },
  },
  txHash: '0xef0ae869f2aa8ef5c60aa7e47cfb1dc463d25f41b1c9322d822bc96b529c7e60',
  detailedExecutionInfo: {
    type: 'MULTISIG',
    submittedAt: 1732816512000,
    nonce: 30,
    safeTxGas: '0',
    baseGas: '0',
    gasPrice: '0',
    gasToken: '0x0000000000000000000000000000000000000000',
    refundReceiver: { value: '0x0000000000000000000000000000000000000000', name: 'MetaMultiSigWallet', logoUri: null },
    safeTxHash: '0xd0d519d3ebd6efac7a9d7c591c0a311193b6acbbf5db970fab6a51e1d3509e72',
    executor: { value: '0xbbeedB6d8e56e23f5812e59d1b6602F15957271F', name: null, logoUri: null },
    signers: [{ value: '0xbbeedB6d8e56e23f5812e59d1b6602F15957271F', name: null, logoUri: null }],
    confirmationsRequired: 1,
    confirmations: [
      {
        signer: { value: '0xbbeedB6d8e56e23f5812e59d1b6602F15957271F', name: null, logoUri: null },
        signature:
          '0x000000000000000000000000bbeedb6d8e56e23f5812e59d1b6602f15957271f000000000000000000000000000000000000000000000000000000000000000001',
        submittedAt: 1732816512000,
      },
    ],
    rejectors: [],
    gasTokenInfo: null,
    trusted: true,
    proposer: null,
    proposedByDelegate: null,
  },
  safeAppInfo: null,
}

// @see https://safe-client.safe.global/v1/chains/11155111/transactions/multisig_0x57c26D4d117c926A872814fa46C179691f580e84_0x1bfa1753ff85b19b9b455a7bf6b5f491e75fef451b01d31dac5236966aa82dbb
const createProxyWithNonceThenFund = {
  safeAddress: '0x57c26D4d117c926A872814fa46C179691f580e84',
  txId: 'multisig_0x57c26D4d117c926A872814fa46C179691f580e84_0x1bfa1753ff85b19b9b455a7bf6b5f491e75fef451b01d31dac5236966aa82dbb',
  executedAt: 1732815948000,
  txStatus: 'SUCCESS',
  txInfo: {
    type: 'Custom',
    humanDescription: null,
    to: {
      value: '0xA1dabEF33b3B82c7814B6D82A79e50F4AC44102B',
      name: 'Safe: MultiSendCallOnly 1.3.0',
      logoUri:
        'https://safe-transaction-assets.safe.global/contracts/logos/0xA1dabEF33b3B82c7814B6D82A79e50F4AC44102B.png',
    },
    dataSize: '836',
    value: '0',
    methodName: 'multiSend',
    actionCount: 2,
    isCancellation: false,
  },
  txData: {
    hexData:
      '0x8d80ff0a000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000002ee004e1dcf7ad4e460cfd30791ccc4f9c8a4f820ec67000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002441688f0b900000000000000000000000041675c099f32341bf84bfc5382af534df5c7461a0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000900000000000000000000000000000000000000000000000000000000000001a4b63e800d00000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000bd89a1ce4dde368ffab0ec35506eece0b1ffdc540000000000000000000000000000000000000000000000000000000000000140000000000000000000000000fd0732dc9e303f09fcef3a7388ad10a83459ec99000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000057c26d4d117c926a872814fa46c179691f580e840000000000000000000000000000000000000000000000000000000000000024fe51f64300000000000000000000000029fcb43b46531bca003ddc8fcb67ffe91900c762000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a1eeb7cc56e9ff272fd2da70cbe18c9c500fc478000000000000000000000000000000000000000000000000016345785d8a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
    dataDecoded: {
      method: 'multiSend',
      parameters: [
        {
          name: 'transactions',
          type: 'bytes',
          value:
            '0x004e1dcf7ad4e460cfd30791ccc4f9c8a4f820ec67000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002441688f0b900000000000000000000000041675c099f32341bf84bfc5382af534df5c7461a0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000900000000000000000000000000000000000000000000000000000000000001a4b63e800d00000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000bd89a1ce4dde368ffab0ec35506eece0b1ffdc540000000000000000000000000000000000000000000000000000000000000140000000000000000000000000fd0732dc9e303f09fcef3a7388ad10a83459ec99000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000057c26d4d117c926a872814fa46c179691f580e840000000000000000000000000000000000000000000000000000000000000024fe51f64300000000000000000000000029fcb43b46531bca003ddc8fcb67ffe91900c762000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a1eeb7cc56e9ff272fd2da70cbe18c9c500fc478000000000000000000000000000000000000000000000000016345785d8a00000000000000000000000000000000000000000000000000000000000000000000',
          valueDecoded: [
            {
              operation: 0,
              to: '0x4e1DCf7AD4e460CfD30791CCC4F9c8a4f820ec67',
              value: '0',
              data: '0x1688f0b900000000000000000000000041675c099f32341bf84bfc5382af534df5c7461a0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000900000000000000000000000000000000000000000000000000000000000001a4b63e800d00000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000bd89a1ce4dde368ffab0ec35506eece0b1ffdc540000000000000000000000000000000000000000000000000000000000000140000000000000000000000000fd0732dc9e303f09fcef3a7388ad10a83459ec99000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000057c26d4d117c926a872814fa46c179691f580e840000000000000000000000000000000000000000000000000000000000000024fe51f64300000000000000000000000029fcb43b46531bca003ddc8fcb67ffe91900c7620000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
              dataDecoded: {
                method: 'createProxyWithNonce',
                parameters: [
                  { name: '_singleton', type: 'address', value: '0x41675C099F32341bf84BFc5382aF534df5C7461a' },
                  {
                    name: 'initializer',
                    type: 'bytes',
                    value:
                      '0xb63e800d00000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000bd89a1ce4dde368ffab0ec35506eece0b1ffdc540000000000000000000000000000000000000000000000000000000000000140000000000000000000000000fd0732dc9e303f09fcef3a7388ad10a83459ec99000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000057c26d4d117c926a872814fa46c179691f580e840000000000000000000000000000000000000000000000000000000000000024fe51f64300000000000000000000000029fcb43b46531bca003ddc8fcb67ffe91900c76200000000000000000000000000000000000000000000000000000000',
                  },
                  { name: 'saltNonce', type: 'uint256', value: '9' },
                ],
              },
            },
            {
              operation: 0,
              to: '0xA1eEB7CC56e9FF272Fd2Da70CBE18c9C500FC478',
              value: '100000000000000000',
              data: null,
              dataDecoded: null,
            },
          ],
        },
      ],
    },
    to: {
      value: '0xA1dabEF33b3B82c7814B6D82A79e50F4AC44102B',
      name: 'Safe: MultiSendCallOnly 1.3.0',
      logoUri:
        'https://safe-transaction-assets.safe.global/contracts/logos/0xA1dabEF33b3B82c7814B6D82A79e50F4AC44102B.png',
    },
    value: '0',
    operation: 1,
    trustedDelegateCallTarget: true,
    addressInfoIndex: {
      '0x4e1DCf7AD4e460CfD30791CCC4F9c8a4f820ec67': {
        value: '0x4e1DCf7AD4e460CfD30791CCC4F9c8a4f820ec67',
        name: 'SafeProxyFactory 1.4.1',
        logoUri:
          'https://safe-transaction-assets.safe.global/contracts/logos/0x4e1DCf7AD4e460CfD30791CCC4F9c8a4f820ec67.png',
      },
      '0x41675C099F32341bf84BFc5382aF534df5C7461a': {
        value: '0x41675C099F32341bf84BFc5382aF534df5C7461a',
        name: 'Safe 1.4.1',
        logoUri:
          'https://safe-transaction-assets.safe.global/contracts/logos/0x41675C099F32341bf84BFc5382aF534df5C7461a.png',
      },
      '0xA1eEB7CC56e9FF272Fd2Da70CBE18c9C500FC478': {
        value: '0xA1eEB7CC56e9FF272Fd2Da70CBE18c9C500FC478',
        name: 'SafeProxy',
        logoUri: null,
      },
    },
  },
  txHash: '0x08d3c281a136d43346433453125afee79f9455bf5810deec3dd3806a42de41b1',
  detailedExecutionInfo: {
    type: 'MULTISIG',
    submittedAt: 1732815948000,
    nonce: 28,
    safeTxGas: '0',
    baseGas: '0',
    gasPrice: '0',
    gasToken: '0x0000000000000000000000000000000000000000',
    refundReceiver: { value: '0x0000000000000000000000000000000000000000', name: 'MetaMultiSigWallet', logoUri: null },
    safeTxHash: '0x1bfa1753ff85b19b9b455a7bf6b5f491e75fef451b01d31dac5236966aa82dbb',
    executor: { value: '0xbbeedB6d8e56e23f5812e59d1b6602F15957271F', name: null, logoUri: null },
    signers: [{ value: '0xbbeedB6d8e56e23f5812e59d1b6602F15957271F', name: null, logoUri: null }],
    confirmationsRequired: 1,
    confirmations: [
      {
        signer: { value: '0xbbeedB6d8e56e23f5812e59d1b6602F15957271F', name: null, logoUri: null },
        signature:
          '0x000000000000000000000000bbeedb6d8e56e23f5812e59d1b6602f15957271f000000000000000000000000000000000000000000000000000000000000000001',
        submittedAt: 1732815948000,
      },
    ],
    rejectors: [],
    gasTokenInfo: null,
    trusted: true,
    proposer: null,
    proposedByDelegate: null,
  },
  safeAppInfo: null,
}

describe('getSetupFromDataDecoded', () => {
  it('should return undefined if no createProxyWithNonce method is found', () => {
    const dataDecoded = {
      method: 'notCreateProxyWithNonce',
    }
    expect(_getSetupFromDataDecoded(dataDecoded)).toBeUndefined()
  })

  it('should return direct createProxyWithNonce calls', () => {
    expect(_getSetupFromDataDecoded(createProxyWithNonce.txData.dataDecoded as unknown as DataDecoded)).toEqual({
      singleton: '0x41675C099F32341bf84BFc5382aF534df5C7461a',
      initializer:
        '0xb63e800d00000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000bd89a1ce4dde368ffab0ec35506eece0b1ffdc540000000000000000000000000000000000000000000000000000000000000140000000000000000000000000fd0732dc9e303f09fcef3a7388ad10a83459ec99000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000057c26d4d117c926a872814fa46c179691f580e840000000000000000000000000000000000000000000000000000000000000024fe51f64300000000000000000000000029fcb43b46531bca003ddc8fcb67ffe91900c76200000000000000000000000000000000000000000000000000000000',
      saltNonce: '11',
    })
  })

  it.each([
    ['_singleton', 0],
    ['initializer', 1],
    ['saltNonce', 2],
  ])('should return undefined if %s is not a string', (_, argIndex) => {
    const dataDecoded = JSON.parse(JSON.stringify(createProxyWithNonce.txData.dataDecoded)) as DataDecoded
    // @ts-expect-error value is a string
    dataDecoded.parameters[argIndex].value = 1
    expect(_getSetupFromDataDecoded(dataDecoded)).toBeUndefined()
  })
})

jest.mock('@/features/multichain/utils/utils', () => ({
  __esModule: true,
  predictSafeAddress: jest.fn(),
}))
jest.mock('@/hooks/wallets/web3', () => ({
  __esModule: true,
  useWeb3ReadOnly: () => {
    return 'Mock provider'
  },
}))

describe('usePredictSafeAddressFromTxDetails', () => {
  it('should pass the correct arguments to predictSafeAddress from a createProxyWithNonce call', () => {
    const mockPredictSafeAddress = jest.spyOn(require('@/features/multichain/utils/utils'), 'predictSafeAddress')

    renderHook(() => usePredictSafeAddressFromTxDetails(createProxyWithNonce as unknown as TransactionDetails))

    expect(mockPredictSafeAddress).toHaveBeenCalledWith(
      {
        singleton: '0x41675C099F32341bf84BFc5382aF534df5C7461a',
        initializer:
          '0xb63e800d00000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000bd89a1ce4dde368ffab0ec35506eece0b1ffdc540000000000000000000000000000000000000000000000000000000000000140000000000000000000000000fd0732dc9e303f09fcef3a7388ad10a83459ec99000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000057c26d4d117c926a872814fa46c179691f580e840000000000000000000000000000000000000000000000000000000000000024fe51f64300000000000000000000000029fcb43b46531bca003ddc8fcb67ffe91900c76200000000000000000000000000000000000000000000000000000000',
        saltNonce: '11',
      },
      '0x4e1DCf7AD4e460CfD30791CCC4F9c8a4f820ec67',
      'Mock provider',
    )
  })

  it('should pass the correct arguments to predictSafeAddress from a multiSend, containing a createProxyWithNonce call', () => {
    const mockPredictSafeAddress = jest.spyOn(require('@/features/multichain/utils/utils'), 'predictSafeAddress')

    renderHook(() => usePredictSafeAddressFromTxDetails(createProxyWithNonceThenFund as unknown as TransactionDetails))

    expect(mockPredictSafeAddress).toHaveBeenCalledWith(
      {
        singleton: '0x41675C099F32341bf84BFc5382aF534df5C7461a',
        initializer:
          '0xb63e800d00000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000bd89a1ce4dde368ffab0ec35506eece0b1ffdc540000000000000000000000000000000000000000000000000000000000000140000000000000000000000000fd0732dc9e303f09fcef3a7388ad10a83459ec99000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000057c26d4d117c926a872814fa46c179691f580e840000000000000000000000000000000000000000000000000000000000000024fe51f64300000000000000000000000029fcb43b46531bca003ddc8fcb67ffe91900c76200000000000000000000000000000000000000000000000000000000',
        saltNonce: '9',
      },
      '0x4e1DCf7AD4e460CfD30791CCC4F9c8a4f820ec67',
      'Mock provider',
    )
  })
})
